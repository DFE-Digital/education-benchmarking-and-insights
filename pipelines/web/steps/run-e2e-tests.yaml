parameters:
  workspaceDir: ''
steps:
  - checkout: none

  - download: current
    artifact: e2e-tests

  - task: ExtractFiles@1
    displayName: 'Extract e2e test files'
    inputs:
      archiveFilePatterns: '${{ parameters.workspaceDir }}/e2e-tests/e2e-tests.zip'
      destinationFolder: '${{ parameters.workspaceDir }}/e2e-tests-files'

  - task: qetza.replacetokens.replacetokens-task.replacetokens@6
    displayName: 'Replace tokens in appsettings.json'
    inputs:
      sources: '${{ parameters.workspaceDir }}/e2e-tests-files/Web.E2ETests/appsettings.json'
      escape: off
      tokenPattern: doubleunderscores

  - task: DotNetCoreCLI@2
    displayName: 'Run e2e tests'
    retryCountOnTaskFailure: 3
    inputs:
      command: test
      projects: '${{ parameters.workspaceDir }}/e2e-tests-files/Web.E2ETests/Web.E2ETests.dll'

  - task: ArchiveFiles@2
    displayName: 'Zip screenshots'
    inputs:
      rootFolderOrFile: '${{ parameters.workspaceDir }}/e2e-tests-files/Web.E2ETests/screenshots'
      includeRootFolder: false
      archiveFile: '$(Build.ArtifactStagingDirectory)/e2e-screenshots.zip'

  - publish: $(Build.ArtifactStagingDirectory)/e2e-screenshots.zip
    artifact: e2e-test-outputs