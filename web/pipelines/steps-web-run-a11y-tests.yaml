parameters:
  workspaceDir: ''
  environmentPrefix: ''
  subscription: ''
  Library : 'Web.A11yTests'
steps:
  - checkout: none
  - download: current
  - task: AzureKeyVault@2
    inputs:
      azureSubscription: ${{ parameters.subscription }}
      KeyVaultName: '${{ parameters.environmentPrefix }}-ebis-keyvault'
      SecretsFilter: '*'
      RunAsPreJob: true
    
  - task: ExtractFiles@1
    displayName: 'Extract a11y test files'
    inputs:
      archiveFilePatterns: '${{ parameters.workspaceDir }}/a11y-tests/a11y-tests.zip'
      destinationFolder: '${{ parameters.workspaceDir }}/a11y-tests-files'
      
  - task: qetza.replacetokens.replacetokens-task.replacetokens@6
    displayName: 'Replace tokens in appsettings.json'
    inputs:
      sources: '${{ parameters.workspaceDir }}/a11y-tests-files/Web.A11yTests/appsettings.json'
      escape: off
      tokenPattern: doubleunderscores

  - task: VSTest@2
    displayName: 'Run A11y Tests'
    inputs:
      testAssemblyVer2: |
        **\${{ parameters.Library }}.dll            
        !**\*TestAdapter.dll
        !**\obj\**
      searchFolder: '${{ parameters.workspaceDir }}/a11y-tests-files'
      testRunTitle: 'A11y Tests - Build $(Build.BuildNumber) - $(FormatDateTime:yyyyMMddHHmmss)'
      rerunFailedTests: true
      uiTests: true
      rerunType: 'basedOnTestFailurePercentage'
      rerunMaxAttempts: '1'
