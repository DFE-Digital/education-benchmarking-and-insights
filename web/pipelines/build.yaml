pool:
  vmImage: 'windows-2022'

trigger:
  batch: true
  branches:
    include:
    - main
  paths:
    include:
    - web

pr:
  paths: 
    include:
    - web
  drafts: false

variables:
  Version.Revision: $[counter(variables['Build.SourceBranchName'], 0)]  
  Version.BuildNumber: 0.0.$(Version.Revision)
  Version.BuildVersion: $(Version.BuildNumber)
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/test/packages
  CACHE_RESTORED: 'false'
  NUGET_PLUGIN_HANDSHAKE_TIMEOUT_IN_SECONDS: 30
  NUGET_PLUGIN_REQUEST_TIMEOUT_IN_SECONDS: 30

stages:
  - stage: Build
    jobs:
      - job: Set_Build_Number
        displayName: 'Set build number'
        steps:
          - checkout: none          
                    
          - bash: |
              echo "##vso[task.setvariable variable=Version.BuildNumber]$(Version.BuildNumber)-prerelease"
              echo "##vso[task.setvariable variable=Version.BuildVersion]$(Version.BuildNumber)"
              echo "##vso[build.updatebuildnumber]$(Version.BuildNumber)-prerelease"
            condition: or(eq(variables['Build.SourceBranch'], 'refs/heads/main'), eq(variables['Build.Reason'], 'PullRequest'))
            displayName: 'Set pre-release build number'

      - job: Zip_Static_artifacts
        displayName: 'Zip static artifacts'
        condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
        steps: 
          - task: ArchiveFiles@2
            displayName: 'Zip terraform files'
            inputs:
              rootFolderOrFile: 'web/terraform'
              includeRootFolder: false
              archiveFile: '$(Build.ArtifactStagingDirectory)/terraform.zip'

          - publish: $(Build.ArtifactStagingDirectory)/terraform.zip
            artifact: terraform

      - job: RunTests
        dependsOn: [Set_Build_Number]
        displayName: 'Run unit tests'
        steps:
          - task: NuGetAuthenticate@1
          
          - task: Cache@2
            displayName: 'Cache nuget packages'
            inputs:
              key: 'nuget | "$(Agent.OS)-web-tests" | web/**/*.Tests*/packages.lock.json,!**/bin/**,!**/obj/**'
              restoreKeys: |
                nuget | "$(Agent.OS)-web-tests"
              path: $(NUGET_PACKAGES)
              cacheHitVar: CACHE_RESTORED

          - task: DotNetCoreCLI@2
            displayName: 'Restore nuget packages'
            condition: ne(variables.CACHE_RESTORED, 'true')
            inputs:
              command: restore
              projects: 'web/**/*.Tests.csproj'
              packagesDirectory: $(NUGET_PACKAGES)
              feedsToUse: 'config'
              nugetConfigPath: 'web/nuget.config'
                              
          - task: DotNetCoreCLI@2
            displayName: 'Run unit tests'
            inputs:
              command: test
              packagesDirectory: $(NUGET_PACKAGES)
              arguments: '--configuration Release --collect "Code coverage" --logger "console;verbosity=detailed" --logger "trx;LogFileName=TestResults.trx"'
              projects: 'web/**/*.Tests.csproj'
              
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'XUnit'
              testResultsFiles: '**/TestResults.trx'

      - job: BuildWeb
        dependsOn: [Set_Build_Number]
        displayName: 'Build web'
        steps:
          - template: steps-web-build.yaml
            parameters:
              BuildVersion: $(Version.BuildVersion)
              BuildNumber: $(Version.BuildNumber)
      
  - stage: DeployDevelopment
    dependsOn: [Build]
    displayName: 'Deploy to development'
    condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
    variables:
      - group: 'dsi pre-prod'
    jobs:
      - template: jobs-web-deployment.yaml
        parameters:
          subscription: 's198d.azdo-deployment'
          environmentPrefix: 's198d01'
          environment: 'development'
          cipEnvironment: 'Dev'